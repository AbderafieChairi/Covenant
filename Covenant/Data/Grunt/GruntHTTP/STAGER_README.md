# GruntHTTPStager Functionality

This document details the functionality of the three stages in the `GruntHTTPStager.cs` execution flow. The stager implements a secure, encrypted key exchange and authentication handshake with the Covenant C2 server before executing the final Grunt payload.

## Overview
The stager uses a pre-shared secret (Setup Password) to establish an initial encrypted channel, which is then used to securely negotiate a unique session key.

### Stage 0: Registration & Key Exchange
**Goal:** Introduce the Grunt to the server and provide a secure channel for the server to reply.

1.  **Preparation**:
    *   Generates a unique `GUID` for this Grunt instance.
    *   Derives a `SetupAESKey` from the pre-shared secret password.
    *   Generates a temporary RSA 2048-bit key pair.
2.  **Action**:
    *   Encrypts the newly generated **RSA Public Key** using the `SetupAESKey`.
    *   Constructs a message with the Grunt's GUID and the encrypted public key.
    *   POSTs this payload to the listener.
3.  **Result**:
    *   The server receives the RSA Public Key. It now has a way to send data back to this specific Grunt that only this Grunt can decrypt (using its private RSA key).

### Stage 1: Session Key Establishment
**Goal:** Receive the unique Session Key from the server and prove the Grunt is live and legitimate.

1.  **Response Processing**:
    *   The stager receives a response from the Stage 0 POST.
    *   It validates the message HMAC.
    *   It decrypts the message layers: first using `SetupAESKey`, then using its **RSA Private Key**.
    *   **Crucial Data**: The decrypted payload contains a new, unique AES `SessionKey` generated by the server.
2.  **Action**:
    *   Generates a random 4-byte `challenge1`.
    *   Encrypts `challenge1` using the new `SessionKey`.
    *   POSTs this encrypted challenge back to the server.

### Stage 2: Authentication & Handoff
**Goal:** Verify the server processed the challenge correctly (mutual authentication) and request the final payload.

1.  **Response Processing**:
    *   The stager receives the response from Stage 1.
    *   It decrypts it using the `SessionKey`.
    *   **Verification**: It checks if the server correctly returned `challenge1`. If this matches, the server is authenticated (it successfully has the Session Key).
    *   The response also contains a new `challenge2` from the server.
2.  **Action**:
    *   Encrypts `challenge2` using the `SessionKey`.
    *   POSTs this back to the server to prove the Grunt is still in sync.
3.  **Final Payload**:
    *   The response to this Stage 2 POST contains the fully encrypted **Grunt Assembly**.
    *   The stager decrypts the assembly using the `SessionKey`, loads it into memory via Reflection, and executes the `GruntExecutor.Grunt.Execute` method.
